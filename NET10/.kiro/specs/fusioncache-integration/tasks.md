# 구현 계획

- [x] 1. FusionCache 패키지 설치 및 기본 설정 구성
  - Demo.Infra 프로젝트에 ZiggyCreatures.FusionCache NuGet 패키지 추가
  - Demo.Infra 프로젝트에 ZiggyCreatures.FusionCache.Serialization.SystemTextJson 패키지 추가
  - FusionCacheConfig 설정 클래스 생성하여 캐시 옵션 정의
  - _요구사항: 1.1, 1.2, 1.3, 1.4_

- [x] 2. IpToNationFusionCache 구현체 개발
  - [x] 2.1 기본 클래스 구조 및 생성자 구현
    - IIpToNationCache 인터페이스를 구현하는 IpToNationFusionCache 클래스 생성
    - IFusionCache 의존성 주입을 위한 생성자 구현
    - 기존 키 생성 로직을 유지하는 MakeKey 메서드 구현
    - _요구사항: 1.1, 5.1, 5.2, 6.2_

  - [x] 2.2 GetAsync 메서드 구현
    - FusionCache.GetOrDefaultAsync를 사용하여 캐시에서 데이터 조회
    - 캐시 미스 시 Result.Fail("Not found") 반환하도록 구현
    - 기존 동작과 동일한 결과를 반환하는 단위 테스트 작성
    - _요구사항: 1.1, 2.1, 2.2_

  - [x] 2.3 SetAsync 메서드 구현
    - FusionCache.SetAsync를 사용하여 캐시에 데이터 저장
    - TimeSpan을 FusionCacheEntryOptions로 변환하는 로직 구현
    - L1과 L2 캐시 모두에 저장되는지 확인하는 단위 테스트 작성
    - _요구사항: 1.2, 2.4, 6.4_

- [x] 3. FusionCache 서비스 등록 및 의존성 주입 설정
  - [x] 3.1 ServiceCollection 확장 메서드 구현
    - AddIpToNationFusionCache 확장 메서드 생성
    - FusionCache 인스턴스를 싱글톤으로 등록
    - IDistributedCache로 Redis 구현체 등록
    - _요구사항: 5.1, 5.3, 6.1_

  - [x] 3.2 FusionCache 옵션 구성
    - L1 캐시 설정 (메모리 제한, TTL 등) 구성
    - L2 캐시 설정 (Redis 연결) 구성
    - 페일세이프, 백그라운드 새로고침 등 고급 기능 활성화
    - _요구사항: 2.1, 2.2, 2.3, 3.1, 3.2, 3.3_

- [x] 4. 기존 Redis 설정과의 호환성 보장
  - [x] 4.1 RedisConfig 통합
    - 기존 RedisConfig를 FusionCache 설정에서 재사용하도록 구현
    - Redis 연결 문자열과 키 접두사 설정 유지
    - Redis 인스트루멘테이션 연동 구현
    - _요구사항: 6.1, 6.2, 6.3_

  - [x] 4.2 기존 데이터 호환성 검증
    - 기존 Redis 키 형식과 동일한 키가 생성되는지 테스트 작성
    - 기존 Redis 데이터를 FusionCache로 읽을 수 있는지 통합 테스트 작성
    - 키 접두사가 올바르게 적용되는지 검증하는 테스트 작성
    - _요구사항: 1.3, 6.4_

- [x] 5. 고급 FusionCache 기능 구현
  - [x] 5.1 백그라운드 새로고침 설정
    - EagerRefresh 옵션을 활성화하여 만료 전 자동 갱신 구현
    - 백그라운드 새로고침이 작동하는지 확인하는 테스트 작성
    - 새로고침 임계점 설정 및 검증
    - _요구사항: 3.1_

  - [x] 5.2 캐시 스탬피드 방지 및 타임아웃 설정
    - 동시 요청에 대한 중복 처리 방지 설정 구현
    - Soft timeout과 Hard timeout 설정 구성
    - 동시성 제어가 올바르게 작동하는지 테스트 작성
    - _요구사항: 3.2, 3.3_

- [ ] 6. OpenTelemetry 및 로깅 통합
  - [x] 6.1 FusionCache OpenTelemetry 계측 설정
    - FusionCache의 OpenTelemetry 확장 패키지 추가
    - 캐시 작업에 대한 메트릭 수집 설정 구현
    - 분산 추적에 FusionCache 작업이 포함되도록 구성
    - _요구사항: 4.1, 4.4_

  - [x] 6.2 로깅 및 모니터링 구현
    - FusionCache 이벤트에 대한 구조화된 로깅 구현
    - 캐시 히트율, 미스율 메트릭 수집 설정
    - 오류 발생 시 적절한 로그 레벨로 기록하는 로직 구현
    - _요구사항: 4.2, 4.3_

- [ ] 7. 단위 테스트 및 통합 테스트 구현
  - [ ] 7.1 IpToNationFusionCache 단위 테스트 작성
    - GetAsync 메서드의 모든 시나리오 테스트 (히트, 미스, 오류)
    - SetAsync 메서드의 정상 동작 및 오류 시나리오 테스트
    - 키 생성 로직이 기존과 동일한지 검증하는 테스트
    - _요구사항: 1.1, 1.2, 1.3, 5.4_

  - [ ] 7.2 L1/L2 캐시 계층 통합 테스트 작성
    - L1 캐시 히트 시나리오 테스트 (빠른 응답 확인)
    - L2 캐시 히트 시나리오 테스트 (Redis에서 조회)
    - L1 캐시에 자동 저장되는지 확인하는 테스트
    - _요구사항: 2.1, 2.2, 2.4_

  - [ ] 7.3 페일오버 및 복원력 테스트 작성
    - Redis 연결 실패 시 L1 캐시만으로 작동하는지 테스트
    - 페일세이프 메커니즘이 올바르게 작동하는지 테스트
    - 타임아웃 시나리오에 대한 테스트 작성
    - _요구사항: 2.3, 3.3, 3.4_

- [ ] 8. 성능 테스트 및 벤치마크 구현
  - [ ] 8.1 응답 시간 벤치마크 테스트 작성
    - L1 캐시 히트 시 응답 시간 측정 테스트
    - L2 캐시 히트 시 응답 시간 측정 테스트
    - 기존 구현체와의 성능 비교 테스트
    - _요구사항: 2.1, 2.2_

  - [ ] 8.2 동시성 및 처리량 테스트 작성
    - 동시 요청 처리 능력 측정 테스트
    - 캐시 스탬피드 방지 효과 검증 테스트
    - 메모리 사용량 모니터링 테스트
    - _요구사항: 3.2_

- [ ] 9. 설정 및 구성 관리 구현
  - [ ] 9.1 appsettings.json 설정 스키마 정의
    - FusionCache 관련 설정 섹션 추가
    - 기존 RedisConfig와의 통합 설정 구현
    - 환경별 설정 오버라이드 지원
    - _요구사항: 5.3, 6.1_

  - [ ] 9.2 설정 유효성 검증 구현
    - 설정 값의 유효성을 검사하는 로직 구현
    - 잘못된 설정 시 명확한 오류 메시지 제공
    - 설정 변경 시 재시작 없이 적용되는 기능 구현
    - _요구사항: 5.3_

- [ ] 10. 마이그레이션 및 배포 준비
  - [ ] 10.1 기존 구현체와의 전환 메커니즘 구현
    - 기능 플래그를 통한 점진적 전환 지원
    - 롤백을 위한 기존 IpToNationRedisCache 보존
    - 설정을 통한 구현체 선택 기능 구현
    - _요구사항: 5.1, 5.2_

  - [ ] 10.2 문서화 및 마이그레이션 가이드 작성
    - FusionCache 전환에 대한 기술 문서 작성
    - 설정 변경 사항 및 새로운 기능에 대한 가이드 작성
    - 성능 개선 사항 및 모니터링 방법 문서화
    - _요구사항: 모든 요구사항의 종합적 검증_
